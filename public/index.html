<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Painel de Lan√ßamentos</title>
                <style>
                        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
                                
                                        .container { max-width: 800px; margin: 0 auto; }
                                                
                                                        /* Cabe√ßalho e Filtros */
                                                                .header { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; }
                                                                        h1 { margin: 0; font-size: 1.5rem; color: #333; }
                                                                                .controls { display: flex; gap: 5px; }
                                                                                        input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
                                                                                                button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
                                                                                                        .btn-filter { background-color: #007bff; }
                                                                                                                .btn-clear { background-color: #6c757d; }

                                                                                                                        /* Lista de Cards */
                                                                                                                                #lista-lancamentos { list-style: none; padding: 0; }
                                                                                                                                        .card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 5px solid #007bff; }
                                                                                                                                                
                                                                                                                                                        .card-header { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
                                                                                                                                                                .mesa-tag { background-color: #e7f1ff; color: #007bff; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
                                                                                                                                                                        .hora { color: #888; font-size: 0.9rem; }

                                                                                                                                                                                /* Itens do Pedido */
                                                                                                                                                                                        .item-pedido { display: flex; justify-content: space-between; padding: 5px 0; font-size: 0.95rem; border-bottom: 1px dotted #eee; }
                                                                                                                                                                                                .item-nome { font-weight: 500; }
                                                                                                                                                                                                        .item-preco { font-family: monospace; font-weight: bold; color: #28a745; }
                                                                                                                                                                                                                .item-link { text-decoration: none; font-size: 1.2rem; margin-left: 10px; }
                                                                                                                                                                                                                        
                                                                                                                                                                                                                                .empty-msg { text-align: center; color: #777; margin-top: 30px; }
                                                                                                                                                                                                                                    </style>
                                                                                                                                                                                                                                    </head>
                                                                                                                                                                                                                                    <body>

                                                                                                                                                                                                                                    <div class="container">
                                                                                                                                                                                                                                        <div class="header">
                                                                                                                                                                                                                                                <h1>Hist√≥rico de Mesas</h1>
                                                                                                                                                                                                                                                        <div class="controls">
                                                                                                                                                                                                                                                                    <input type="text" id="filtroMesa" placeholder="N¬∫ Mesa...">
                                                                                                                                                                                                                                                                                <button class="btn-filter" onclick="carregarDados()">Filtrar</button>
                                                                                                                                                                                                                                                                                            <button class="btn-clear" onclick="limpar()">X</button>
                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                        </div>

                                                                                                                                                                                                                                                                                                            <div id="lista-lancamentos">
                                                                                                                                                                                                                                                                                                                    <p class="empty-msg">Carregando dados...</p>
                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                        </div>

                                                                                                                                                                                                                                                                                                                        <script>
                                                                                                                                                                                                                                                                                                                            async function carregarDados() {
                                                                                                                                                                                                                                                                                                                                    const mesa = document.getElementById('filtroMesa').value;
                                                                                                                                                                                                                                                                                                                                            const url = mesa ? `/api/historico?mesa=${mesa}` : '/api/historico';
                                                                                                                                                                                                                                                                                                                                                    const container = document.getElementById('lista-lancamentos');

                                                                                                                                                                                                                                                                                                                                                            try {
                                                                                                                                                                                                                                                                                                                                                                        const req = await fetch(url);
                                                                                                                                                                                                                                                                                                                                                                                    const dados = await req.json();

                                                                                                                                                                                                                                                                                                                                                                                                container.innerHTML = '';

                                                                                                                                                                                                                                                                                                                                                                                                            if (dados.length === 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                            container.innerHTML = '<p class="empty-msg">Nenhum lan√ßamento encontrado.</p>';
                                                                                                                                                                                                                                                                                                                                                                                                                                            return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                    dados.forEach(d => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Monta o HTML dos produtos
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    let itensHtml = '';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (d.detalhes && d.detalhes.length > 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        itensHtml = d.detalhes.map(item => `
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="item-pedido">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <span style="color:#999; font-size:0.8em;">${item.codigo || ''}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <span class="item-nome">${item.texto}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <span class="item-preco">${item.preco}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <a href="${item.href}" target="_blank" class="item-link" title="Abrir link original">üîó</a>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            `).join('');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                itensHtml = '<div style="color:#ccc; font-style:italic;">Sem produtos capturados</div>';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // Cria o Card
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const card = document.createElement('div');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                card.className = 'card';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                card.innerHTML = `
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="card-header">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <span class="mesa-tag">Mesa: ${d.mesa}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <span class="hora">${d.data_hora}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div>${itensHtml}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            `;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            container.appendChild(card);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                } catch (erro) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            console.error(erro);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        container.innerHTML = '<p class="empty-msg" style="color:red">Erro ao conectar com o servidor.</p>';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        function limpar() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                document.getElementById('filtroMesa').value = '';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        carregarDados();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // Atualiza a cada 8 segundos
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    setInterval(carregarDados, 8000);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // Carrega inicial
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                carregarDados();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </script>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </body>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </html>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                