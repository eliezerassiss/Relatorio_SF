<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>LeChef Monitor</title>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #111;
    color: #fff;
}
header {
    padding: 15px;
    background: #000;
    text-align: center;
    font-size: 20px;
}
#stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px,1fr));
    gap: 10px;
    padding: 10px;
}
.stat {
    background: #222;
    padding: 10px;
    border-radius: 8px;
    text-align: center;
}
.stat h2 {
    margin: 0;
    color: #4caf50;
}
#log {
    padding: 10px;
}
.card {
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 8px;
}
.consulta { background:#1e88e5; }
.lancamento { background:#ff9800; }
.payload {
    background: rgba(0,0,0,.3);
    margin-top: 5px;
    padding: 5px;
    font-size: 13px;
}
</style>
</head>

<body>

<header>ðŸ“¡ LeChef â€“ Monitoramento em Tempo Real</header>

<section id="stats"></section>
<div id="log"></div>

<script>
const logDiv = document.getElementById('log');
const statsDiv = document.getElementById('stats');

function parsePayload(p) {
    if (!p || typeof p !== 'string') return '';
    return p.split('&').map(i => {
        const [k,v] = i.split('=');
        return `<div><b>${decodeURIComponent(k)}</b>: ${decodeURIComponent(v||'')}</div>`;
    }).join('');
}

async function atualizarLog() {
    const r = await fetch('/api/historico');
    const d = await r.json();
    logDiv.innerHTML = '';

    d.forEach(i => {
        const c = document.createElement('div');
        c.className = 'card ' + (i.tipo === 'CONSULTA' ? 'consulta' : 'lancamento');
        c.innerHTML = `
            <b>Mesa:</b> ${i.mesa}<br>
            <b>AÃ§Ã£o:</b> ${i.tipo}<br>
            <b>Hora:</b> ${new Date(i.timestamp).toLocaleString()}
            <div class="payload">${parsePayload(i.payload)}</div>
        `;
        logDiv.appendChild(c);
    });
}

async function atualizarStats() {
    const r = await fetch('/api/estatisticas');
    const s = await r.json();

    statsDiv.innerHTML = `
        <div class="stat"><h2>${s.total}</h2>Total</div>
        <div class="stat"><h2>${s.consultas}</h2>Consultas</div>
        <div class="stat"><h2>${s.lancamentos}</h2>LanÃ§amentos</div>
        <div class="stat"><h2>${Object.keys(s.mesas).length}</h2>Mesas Ativas</div>
        <div class="stat"><h2>${s.ultima ? new Date(s.ultima).toLocaleTimeString() : '-'}</h2>Ãšltima</div>
    `;
}

atualizarLog();
atualizarStats();
setInterval(() => {
    atualizarLog();
    atualizarStats();
}, 5000);
</script>

</body>
</html>